<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamyBeautyHub - Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #FDF8F5;
            --sidebar-bg: #FFFFFF;
            --text-color: #5C5470;
            --text-light: #9a93a7;
            --heading-color: #B2839A;
            --primary-color: #E6A4B4;
            --primary-dark: #d68fa3;
            --card-bg: #FFFFFF;
            --shadow: 0 6px 20px rgba(178, 131, 154, 0.08);
            --border-radius: 16px;
            --border-color: #F3E5E3;
            --font-body: 'Montserrat', sans-serif;
            --font-heading: 'Playfair Display', serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #auth-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease;
        }
        #auth-modal {
            background: var(--card-bg); padding: 40px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); text-align: center; width: 90%; max-width: 350px;
        }
        #auth-modal h2 { font-family: var(--font-heading); color: var(--heading-color); margin-bottom: 20px; }
        #auth-modal input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; font-family: var(--font-body); }
        #auth-modal input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(230, 164, 180, 0.2); }
        #auth-modal button { width: 100%; }
        #auth-modal p { margin-top: 15px; color: #e74c3c; }

        #admin-panel { display: none; width: 100%; height: 100vh; }
        .sidebar {
            width: 260px; background: var(--sidebar-bg); padding: 25px;
            display: flex; flex-direction: column; border-right: 1px solid var(--border-color); flex-shrink: 0;
        }
        .sidebar-header { text-align: center; margin-bottom: 40px; }
        .sidebar-header img {
            max-width: 160px;
            margin-bottom: 10px;
        }
        .sidebar-header p { font-size: 0.9rem; color: #aaa; }
        .sidebar-nav ul { list-style: none; }
        .sidebar-nav li a {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            color: var(--text-color); text-decoration: none; border-radius: 10px;
            margin-bottom: 8px; transition: all 0.3s; font-weight: 500;
        }
        .sidebar-nav li a.active, .sidebar-nav li a:hover { background-color: var(--primary-color); color: white; }
        .sidebar-nav li a svg { width: 20px; height: 20px; transition: transform 0.3s; }
        .sidebar-nav li a:hover svg { transform: scale(1.1); }

        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header {
            font-family: var(--font-heading); color: var(--heading-color);
            font-size: 2.5rem; margin-bottom: 30px;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card {
            background: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow);
            border: 1px solid var(--border-color); display: flex; align-items: center; gap: 20px;
        }
        .stat-card .icon {
            width: 48px; height: 48px; border-radius: 50%; display: grid; place-items: center;
            background-color: #FBEFF2; color: var(--primary-color);
        }
        .stat-card .icon svg { width: 24px; height: 24px; }
        .stat-card h4 { color: var(--text-light); font-weight: 500; font-size: 0.9rem; margin-bottom: 2px; }
        .stat-card p { font-size: 2.2rem; font-weight: 600; color: var(--heading-color); line-height: 1.1; }
        
        .section-header { font-family: var(--font-heading); color: var(--heading-color); margin-bottom: 20px; font-size: 1.5rem; }
        .table-wrapper { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border-color); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background: #FDF8F5; font-weight: 600; font-size: 0.9rem; color: var(--text-light); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background-color: #FAF6F4; }
        .data-table .actions { display: flex; gap: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; transition: background-color 0.2s; }
        .action-btn:hover { background-color: #eee; }
        .action-btn svg { width: 18px; height: 18px; color: var(--text-light); }
        .action-btn.delete:hover svg { color: #e74c3c; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-badge.active { background-color: #58D68D; }
        .status-badge.hidden { background-color: #BDC3C7; }
        
        button {
            padding: 10px 20px; border: none; background-color: var(--primary-color);
            color: white; border-radius: 10px; cursor: pointer;
            font-family: var(--font-body); font-size: 0.9rem; font-weight: 600;
            transition: all 0.3s; display: inline-flex; justify-content: center; align-items: center; gap: 8px;
        }
        button:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .page-actions { margin-bottom: 25px; }
        
        form { display: flex; flex-direction: column; gap: 18px; }
        form label { font-weight: 600; color: var(--heading-color); font-size: 0.9rem; }
        form input, form textarea, form select { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: var(--font-body); font-size: 1rem; }
        form input:focus, form textarea:focus, form select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(230, 164, 180, 0.2); }
        form textarea { min-height: 120px; resize: vertical; }

        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(92, 84, 112, 0.4); z-index: 900;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); animation: fadeInModal 0.3s;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: var(--card-bg); padding: 30px; border-radius: var(--border-radius);
            width: 90%; max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            animation: slideInModal 0.4s ease-out;
        }
        @keyframes slideInModal { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-header h3 { font-family: var(--font-heading); color: var(--heading-color); font-size: 1.8rem; }
        .modal-body { max-height: 70vh; overflow-y: auto; padding-right: 10px; }
        
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background-color: var(--text-color); color: white; padding: 15px 20px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 500;
            opacity: 0; transform: translateY(20px); animation: toastIn 0.5s forwards;
        }
        .toast.success { background-color: #27ae60; }
        .toast.error { background-color: #e74c3c; }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
        
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div id="auth-modal">
            <h2>Admin Access</h2>
            <input type="password" id="admin-code" placeholder="Enter Admin Code">
            <button id="login-button">Enter</button>
            <p id="auth-error" style="display: none;">Access Denied</p>
        </div>
    </div>
    
    <div id="admin-panel">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://i.ibb.co/C573fCwc/dreamybeautyhublogo.png" alt="dreamybeautyhublogo">
                <p>Admin Panel</p>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#dashboard" class="nav-link active">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        Dashboard
                    </a></li>
                    <li><a href="#categories" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                        Categories
                    </a></li>
                    <li><a href="#items" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        Items
                    </a></li>
                    <li><a href="#settings" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        Settings
                    </a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <!-- Dashboard Page -->
            <section id="dashboard-page" class="page active">
                <h1 class="page-header">Dashboard</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg></div>
                        <div><h4>Total Categories</h4><p id="total-categories">0</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg></div>
                        <div><h4>Total Items</h4><p id="total-items">0</p></div>
                    </div>
                </div>
                <h3 class="section-header">Latest Categories</h3>
                 <div class="table-wrapper">
                    <table class="data-table" id="latest-categories-table">
                        <thead><tr><th>Name</th><th>Created At</th></tr></thead>
                        <tbody><tr><td colspan="2">Loading...</td></tr></tbody>
                    </table>
                </div>
                 <h3 class="section-header" style="margin-top: 30px;">Latest Items</h3>
                <div class="table-wrapper">
                    <table class="data-table" id="latest-items-table">
                        <thead><tr><th>Title</th><th>Created At</th></tr></thead>
                        <tbody><tr><td colspan="2">Loading...</td></tr></tbody>
                    </table>
                </div>
            </section>

            <!-- Categories Page -->
            <section id="categories-page" class="page">
                <h1 class="page-header">Manage Categories</h1>
                <div class="page-actions"><button id="add-category-btn">Add New Category</button></div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Name</th><th>Status</th><th>Created At</th><th>Actions</th></tr></thead>
                        <tbody id="categories-table-body"></tbody>
                    </table>
                </div>
            </section>

            <!-- Items Page -->
            <section id="items-page" class="page">
                 <h1 class="page-header">Manage Items</h1>
                 <div class="page-actions"><button id="add-item-btn">Add New Item</button></div>
                 <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Title</th><th>Category</th><th>Status</th><th>Created At</th><th>Actions</th></tr></thead>
                        <tbody id="items-table-body"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Settings Page -->
            <section id="settings-page" class="page">
                <h1 class="page-header">Site Settings</h1>
                <div class="table-wrapper" style="padding: 30px; max-width: 700px;">
                    <form id="settings-form">
                        <h3 class="section-header" style="margin-bottom: 10px;">General</h3>
                        <label for="siteTitle">Site Title</label>
                        <input type="text" id="siteTitle" required>
                        <label for="tagline">Tagline</label>
                        <input type="text" id="tagline">
                        <label for="showCategoriesOnHome">Show Categories on Homepage</label>
                        <select id="showCategoriesOnHome"><option value="true">Yes</option><option value="false">No</option></select>
                        <label for="showSearch">Show Search Bar</label>
                        <select id="showSearch"><option value="true">Yes</option><option value="false">No</option></select>

                        <h3 class="section-header" style="margin-top: 30px; margin-bottom: 10px;">Navigation Menu</h3>
                        <label for="showContactLink">Show "Contact Us" Link</label>
                        <select id="showContactLink"><option value="true">Yes</option><option value="false">No</option></select>
                        <label for="contactUrl">Contact Us URL</label>
                        <input type="url" id="contactUrl" placeholder="https://example.com/contact">
                        
                        <label for="showSocialLinks">Show Social Media Links</label>
                        <select id="showSocialLinks"><option value="true">Yes</option><option value="false">No</option></select>
                        <label for="facebookUrl">Facebook URL</label>
                        <input type="url" id="facebookUrl" placeholder="https://facebook.com/yourpage">
                        <label for="instagramUrl">Instagram URL</label>
                        <input type="url" id="instagramUrl" placeholder="https://instagram.com/yourpage">
                        <label for="twitterUrl">Twitter URL</label>
                        <input type="url" id="twitterUrl" placeholder="https://twitter.com/yourpage">
                        
                        <button type="submit">Save Settings</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Category</h3><button class="action-btn" onclick="document.getElementById('category-modal').style.display='none'"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    <label for="category-name">Name</label>
                    <input type="text" id="category-name" required>
                    <label for="category-description">Description</label>
                    <textarea id="category-description"></textarea>
                    <label for="category-thumbnailUrl">Thumbnail URL</label>
                    <input type="url" id="category-thumbnailUrl" placeholder="Paste ImgDB URL here...">
                    <label for="category-status">Status</label>
                    <select id="category-status"><option value="active">Active</option><option value="hidden">Hidden</option></select>
                    <button type="submit">Save Category</button>
                </form>
            </div>
        </div>
    </div>
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Item</h3><button class="action-btn" onclick="document.getElementById('item-modal').style.display='none'"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
            <div class="modal-body">
                <form id="item-form">
                    <input type="hidden" id="item-id">
                    <label for="item-category">Category</label>
                    <select id="item-category" required></select>
                    <label for="item-title">Title</label>
                    <input type="text" id="item-title" required>
                    <label for="item-description">Description</label>
                    <textarea id="item-description"></textarea>
                    <label for="item-imageUrl">Image URL</label>
                    <input type="url" id="item-imageUrl" placeholder="Paste ImgDB URL here...">
                    <label for="item-status">Status</label>
                    <select id="item-status"><option value="active">Active</option><option value="hidden">Hidden</option></select>
                    <button type="submit">Save Item</button>
                </form>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy, limit, addDoc, updateDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApYYIEiyvpNGO9m1g7JBA3e4Q6x1CSrMM",
            authDomain: "dreamybeautyhub-b0500.firebaseapp.com",
            projectId: "dreamybeautyhub-b0500",
            storageBucket: "dreamybeautyhub-b0500.appspot.com",
            messagingSenderId: "465258211378",
            appId: "1:465258211378:web:2635d10695b0a39970742b",
            measurementId: "G-CLQSNKV9GE"
        };
        
        // --- AUTH ---
        const ADMIN_CODE = "798582";
        const authOverlay = document.getElementById('auth-overlay');
        document.getElementById('login-button').addEventListener('click', () => {
            const code = document.getElementById('admin-code').value;
            if (code === ADMIN_CODE) {
                authOverlay.style.opacity = '0';
                setTimeout(() => {
                    authOverlay.style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'flex';
                    initializeAppAndLoadData();
                }, 300);
            } else {
                const errorEl = document.getElementById('auth-error');
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 2000);
            }
        });
        document.getElementById('admin-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('login-button').click();
        });
        
        // --- FIREBASE & APP LOGIC ---
        let app, db;
        
        function initializeAppAndLoadData() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                setupNav();
                loadDashboard();
            } catch(e) {
                console.error("Firebase initialization failed:", e);
                showToast("Could not connect to the database.", "error");
            }
        }

        // --- NAVIGATION ---
        function setupNav() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1) + '-page';
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    pages.forEach(p => p.classList.remove('active'));
                    document.getElementById(targetId).classList.add('active');
                    
                    switch(targetId) {
                        case 'dashboard-page': loadDashboard(); break;
                        case 'categories-page': loadCategories(); break;
                        case 'items-page': loadItems(); break;
                        case 'settings-page': loadSettings(); break;
                    }
                });
            });
        }
        
        // --- UTILS ---
        const formatDate = (timestamp) => timestamp ? new Date(timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
        const showLoaderInTbody = (tbody, colspan) => { tbody.innerHTML = `<tr><td colspan="${colspan}">Loading...</td></tr>`; };
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };
        const createActionButton = (title, iconPath, ...classes) => {
            const btn = document.createElement('button');
            btn.title = title;
            btn.className = `action-btn ${classes.join(' ')}`;
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${iconPath}</svg>`;
            return btn;
        };
        const toggleButtonLoading = (button, isLoading) => {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = `<span class="spinner"></span> Saving...`;
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText;
            }
        };
        const isValidDirectImageUrl = (url) => {
            if (!url || url.trim() === '') {
                return true; // Optional field, valid if empty
            }
            const lowercasedUrl = url.toLowerCase();
            const startsWithHttp = lowercasedUrl.startsWith('http://') || lowercasedUrl.startsWith('https://');
            const endsWithImageExtension = /\.(jpg|jpeg|png|webp)$/.test(lowercasedUrl);
            const isViewerLink = lowercasedUrl.includes('//ibb.co/') || 
                                 lowercasedUrl.includes('//imgbb.com/');
            
            return startsWithHttp && endsWithImageExtension && !isViewerLink;
        };

        // --- DASHBOARD ---
        async function loadDashboard() {
            try {
                const categoriesSnap = await getDocs(collection(db, "categories"));
                document.getElementById('total-categories').textContent = categoriesSnap.size;
                const itemsSnap = await getDocs(collection(db, "items"));
                document.getElementById('total-items').textContent = itemsSnap.size;
                
                const latestCatQuery = query(collection(db, "categories"), orderBy("createdAt", "desc"), limit(5));
                const latestCatSnap = await getDocs(latestCatQuery);
                const catTbody = document.getElementById('latest-categories-table').querySelector('tbody');
                catTbody.innerHTML = latestCatSnap.docs.length > 0 ? latestCatSnap.docs.map(doc => `<tr><td>${doc.data().name}</td><td>${formatDate(doc.data().createdAt)}</td></tr>`).join('') : `<tr><td colspan="2">No categories yet.</td></tr>`;

                const latestItemQuery = query(collection(db, "items"), orderBy("createdAt", "desc"), limit(5));
                const latestItemSnap = await getDocs(latestItemQuery);
                const itemTbody = document.getElementById('latest-items-table').querySelector('tbody');
                itemTbody.innerHTML = latestItemSnap.docs.length > 0 ? latestItemSnap.docs.map(doc => `<tr><td>${doc.data().title}</td><td>${formatDate(doc.data().createdAt)}</td></tr>`).join('') : `<tr><td colspan="2">No items yet.</td></tr>`;
            } catch (e) { console.error("Error loading dashboard:", e); }
        }

        // --- CATEGORIES ---
        async function loadCategories() {
            const tbody = document.getElementById('categories-table-body');
            showLoaderInTbody(tbody, 4);
            try {
                const q = query(collection(db, "categories"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                tbody.innerHTML = '';
                if (querySnapshot.empty) { tbody.innerHTML = `<tr><td colspan="4">No categories found. Click 'Add New Category' to start.</td></tr>`; return; }
                
                querySnapshot.forEach(doc => {
                    const cat = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cat.name}</td>
                        <td><span class="status-badge ${cat.status}">${cat.status}</span></td>
                        <td>${formatDate(cat.createdAt)}</td>
                    `;
                    const actionsTd = document.createElement('td');
                    actionsTd.className = 'actions';
                    const editBtn = createActionButton('Edit', '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>', 'edit-cat-btn');
                    const toggleBtn = createActionButton(cat.status === 'active' ? 'Hide' : 'Show', cat.status === 'active' ? '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>' : '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>', 'toggle-cat-status-btn');
                    const deleteBtn = createActionButton('Delete', '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>', 'delete', 'delete-cat-btn');
                    editBtn.dataset.id = toggleBtn.dataset.id = deleteBtn.dataset.id = doc.id;
                    toggleBtn.dataset.status = cat.status;
                    actionsTd.append(editBtn, toggleBtn, deleteBtn);
                    tr.appendChild(actionsTd);
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error("Error loading categories:", e); tbody.innerHTML = `<tr><td colspan="4">Error loading data. Check console for index errors.</td></tr>`; }
        }
        
        // --- ITEMS ---
        let categoriesCache = [];
        async function loadItems() {
             const tbody = document.getElementById('items-table-body');
             showLoaderInTbody(tbody, 5);
             try {
                const catSnap = await getDocs(collection(db, "categories"));
                categoriesCache = catSnap.docs.map(d => ({id: d.id, ...d.data()}));
                const categoryMap = new Map(categoriesCache.map(c => [c.id, c.name]));

                const q = query(collection(db, "items"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                tbody.innerHTML = '';
                if (querySnapshot.empty) { tbody.innerHTML = `<tr><td colspan="5">No items found. Click 'Add New Item' to start.</td></tr>`; return; }
                
                querySnapshot.forEach(doc => {
                    const item = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.title}</td>
                        <td>${categoryMap.get(item.categoryId) || 'Unknown'}</td>
                        <td><span class="status-badge ${item.status}">${item.status}</span></td>
                        <td>${formatDate(item.createdAt)}</td>
                    `;
                    const actionsTd = document.createElement('td');
                    actionsTd.className = 'actions';
                    const editBtn = createActionButton('Edit', '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>', 'edit-item-btn');
                    const toggleBtn = createActionButton(item.status === 'active' ? 'Hide' : 'Show', item.status === 'active' ? '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>' : '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>', 'toggle-item-status-btn');
                    const deleteBtn = createActionButton('Delete', '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>', 'delete', 'delete-item-btn');
                    editBtn.dataset.id = toggleBtn.dataset.id = deleteBtn.dataset.id = doc.id;
                    toggleBtn.dataset.status = item.status;
                    actionsTd.append(editBtn, toggleBtn, deleteBtn);
                    tr.appendChild(actionsTd);
                    tbody.appendChild(tr);
                });
             } catch (e) { console.error("Error loading items:", e); tbody.innerHTML = `<tr><td colspan="5">Error loading data. Check console for index errors.</td></tr>`; }
        }
        
        // --- SETTINGS ---
        async function loadSettings() {
            try {
                const docRef = doc(db, "settings", "global");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('siteTitle').value = data.siteTitle || '';
                    document.getElementById('tagline').value = data.tagline || '';
                    document.getElementById('showCategoriesOnHome').value = data.showCategoriesOnHome ? 'true' : 'false';
                    document.getElementById('showSearch').value = data.showSearch ? 'true' : 'false';
                    document.getElementById('showContactLink').value = data.showContactLink ? 'true' : 'false';
                    document.getElementById('contactUrl').value = data.contactUrl || '';
                    document.getElementById('showSocialLinks').value = data.showSocialLinks ? 'true' : 'false';
                    document.getElementById('facebookUrl').value = data.facebookUrl || '';
                    document.getElementById('instagramUrl').value = data.instagramUrl || '';
                    document.getElementById('twitterUrl').value = data.twitterUrl || '';
                }
            } catch (e) { console.error("Error loading settings:", e); }
        }
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            const settings = {
                siteTitle: document.getElementById('siteTitle').value,
                tagline: document.getElementById('tagline').value,
                showCategoriesOnHome: document.getElementById('showCategoriesOnHome').value === 'true',
                showSearch: document.getElementById('showSearch').value === 'true',
                showContactLink: document.getElementById('showContactLink').value === 'true',
                contactUrl: document.getElementById('contactUrl').value,
                showSocialLinks: document.getElementById('showSocialLinks').value === 'true',
                facebookUrl: document.getElementById('facebookUrl').value,
                instagramUrl: document.getElementById('instagramUrl').value,
                twitterUrl: document.getElementById('twitterUrl').value,
            };
            await setDoc(doc(db, "settings", "global"), settings);
            toggleButtonLoading(button, false);
            showToast('Settings saved!');
        });
        
        // --- MODAL & FORM LOGIC ---
        const categoryModal = document.getElementById('category-modal');
        const categoryForm = document.getElementById('category-form');
        document.getElementById('add-category-btn').addEventListener('click', () => {
            categoryForm.reset();
            document.getElementById('category-id').value = '';
            categoryModal.style.display = 'flex';
        });
        
        const itemModal = document.getElementById('item-modal');
        const itemForm = document.getElementById('item-form');
        document.getElementById('add-item-btn').addEventListener('click', () => {
            itemForm.reset();
            document.getElementById('item-id').value = '';
            const catSelect = document.getElementById('item-category');
            catSelect.innerHTML = categoriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if(categoriesCache.length === 0) {
                showToast("Please add a category first before adding items.", "error");
                return;
            }
            itemModal.style.display = 'flex';
        });
        
        // --- EVENT DELEGATION FOR TABLES ---
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('.action-btn');
            if (!target) return;

            if (target.matches('.edit-cat-btn')) {
                const id = target.dataset.id;
                const docSnap = await getDoc(doc(db, "categories", id));
                if (!docSnap.exists()) return;
                const data = docSnap.data();
                document.getElementById('category-id').value = id;
                document.getElementById('category-name').value = data.name;
                document.getElementById('category-description').value = data.description || '';
                document.getElementById('category-thumbnailUrl').value = data.thumbnailUrl || '';
                document.getElementById('category-status').value = data.status;
                categoryModal.style.display = 'flex';
            }
            if (target.matches('.delete-cat-btn')) {
                if (!confirm('Are you sure you want to delete this category?')) return;
                await deleteDoc(doc(db, "categories", target.dataset.id));
                loadCategories();
                showToast('Category deleted.');
            }
            if (target.matches('.toggle-cat-status-btn')) {
                const id = target.dataset.id;
                const newStatus = target.dataset.status === 'active' ? 'hidden' : 'active';
                await updateDoc(doc(db, "categories", id), { status: newStatus });
                loadCategories();
            }
            if (target.matches('.edit-item-btn')) {
                const id = target.dataset.id;
                const docSnap = await getDoc(doc(db, "items", id));
                if (!docSnap.exists()) return;
                const data = docSnap.data();
                const catSelect = document.getElementById('item-category');
                catSelect.innerHTML = categoriesCache.map(c => `<option value="${c.id}" ${c.id === data.categoryId ? 'selected' : ''}>${c.name}</option>`).join('');
                document.getElementById('item-id').value = id;
                document.getElementById('item-title').value = data.title;
                document.getElementById('item-description').value = data.description || '';
                document.getElementById('item-imageUrl').value = data.imageUrl || '';
                document.getElementById('item-status').value = data.status;
                itemModal.style.display = 'flex';
            }
            if (target.matches('.delete-item-btn')) {
                if (!confirm('Are you sure? This action cannot be undone.')) return;
                await deleteDoc(doc(db, "items", target.dataset.id));
                loadItems();
                showToast('Item deleted.');
            }
            if (target.matches('.toggle-item-status-btn')) {
                const id = target.dataset.id;
                const newStatus = target.dataset.status === 'active' ? 'hidden' : 'active';
                await updateDoc(doc(db, "items", id), { status: newStatus });
                loadItems();
            }
        });
        
        // --- FORM SUBMISSIONS ---
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);

            const thumbnailUrl = document.getElementById('category-thumbnailUrl').value;
            if (!isValidDirectImageUrl(thumbnailUrl)) {
                alert("Please paste a direct image link (ending with .jpg/.png).");
                toggleButtonLoading(button, false);
                return;
            }

            const id = document.getElementById('category-id').value;
            try {
                if (id) {
                    const dataToUpdate = {
                        name: document.getElementById('category-name').value,
                        description: document.getElementById('category-description').value,
                        status: document.getElementById('category-status').value,
                        thumbnailUrl: thumbnailUrl,
                    };
                    await updateDoc(doc(db, "categories", id), dataToUpdate);
                } else {
                    const dataToCreate = {
                        name: document.getElementById('category-name').value,
                        description: document.getElementById('category-description').value,
                        status: document.getElementById('category-status').value,
                        createdAt: serverTimestamp(),
                        thumbnailUrl: thumbnailUrl,
                    };
                    await addDoc(collection(db, "categories"), dataToCreate);
                }
                showToast(`Category ${id ? 'updated' : 'created'} successfully!`);
                categoryForm.reset();
                categoryModal.style.display = 'none';
                loadCategories();
                loadDashboard();
            } catch (err) {
                showToast('An error occurred.', 'error');
                console.error(err);
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            
            const imageUrl = document.getElementById('item-imageUrl').value;
            if (!isValidDirectImageUrl(imageUrl)) {
                alert("Please paste a direct image link (ending with .jpg/.png).");
                toggleButtonLoading(button, false);
                return;
            }

            const id = document.getElementById('item-id').value;
            try {
                if (id) {
                    const dataToUpdate = {
                        categoryId: document.getElementById('item-category').value,
                        title: document.getElementById('item-title').value,
                        description: document.getElementById('item-description').value,
                        status: document.getElementById('item-status').value,
                        imageUrl: imageUrl,
                    };
                    await updateDoc(doc(db, "items", id), dataToUpdate);
                } else {
                    const dataToCreate = {
                        categoryId: document.getElementById('item-category').value,
                        title: document.getElementById('item-title').value,
                        description: document.getElementById('item-description').value,
                        status: document.getElementById('item-status').value,
                        createdAt: serverTimestamp(),
                        imageUrl: imageUrl,
                    };
                    await addDoc(collection(db, "items"), dataToCreate);
                }
                showToast(`Item ${id ? 'updated' : 'created'} successfully!`);
                itemForm.reset();
                itemModal.style.display = 'none';
                loadItems();
                loadDashboard();
            } catch (err) {
                showToast('An error occurred.', 'error');
                console.error(err);
            } finally {
                toggleButtonLoading(button, false);
            }
        });
    </script>
</body>
</html>
