<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamyBeautyHub - Creator Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              serif: ['Playfair Display', 'serif'],
              mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
            },
            colors: {
              brand: {
                50: '#fff1f2',
                100: '#ffe4e6',
                200: '#fecdd3',
                300: '#fda4af',
                400: '#fb7185',
                500: '#f43f5e', // Rose
                600: '#e11d48',
              },
              gold: {
                 500: '#c5a059',
              }
            }
          }
        }
      }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Professional View Transition */
        @keyframes slideUpFade {
            0% { opacity: 0; transform: translateY(12px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-enter { 
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        /* Button Press Effect */
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }

        /* Visual Editor Styles */
        #visual-editor p { margin-bottom: 1em; }
        #visual-editor h2 { font-size: 1.5em; font-weight: bold; margin-top: 1.5em; margin-bottom: 0.5em; line-height: 1.3; }
        #visual-editor blockquote { border-left: 4px solid #f43f5e; padding-left: 1em; font-style: italic; color: #555; margin: 1.5em 0; }
        #visual-editor ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        #visual-editor ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        #visual-editor a { color: #f43f5e; text-decoration: underline; cursor: pointer; }
        #visual-editor img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1.5em 0; display: block; }
        #visual-editor b, #visual-editor strong { font-weight: bold; }
        #visual-editor i, #visual-editor em { font-style: italic; }
    </style>
</head>
<body class="bg-rose-50 min-h-screen">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[60] flex flex-col gap-3 pointer-events-none"></div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCGtnvcrDBBcLDUG1JRlXyIMtSezNg0GwQ",
          authDomain: "dreamybeautyhub-3e78c.firebaseapp.com",
          databaseURL: "https://dreamybeautyhub-3e78c-default-rtdb.firebaseio.com",
          projectId: "dreamybeautyhub-3e78c",
          storageBucket: "dreamybeautyhub-3e78c.firebasestorage.app",
          messagingSenderId: "68196766734",
          appId: "1:68196766734:web:b7f35fae922854a70a985f",
          measurementId: "G-66PC2D53VP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Global State ---
        let currentPosts = {};
        let currentSubscribers = {};
        let currentPages = {};
        let currentSettings = {
            brandName: 'DREAMYBEAUTYHUB',
            brandLogo: '',
            freeImageHostApiKey: '',
            adminPasscode: '798582'
        };
        let isAuthenticated = sessionStorage.getItem('admin_auth') === 'true';
        let isSettingsLoaded = false;
        
        // Track ad code for the currently open post
        let currentPostAdCode = "";

        // --- Helpers ---
        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-xl text-sm font-medium transform transition-all duration-500 translate-y-10 opacity-0 ${isError ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-gray-900 text-white'}`;
            toast.innerHTML = `
                <i data-lucide="${isError ? 'alert-circle' : 'check-circle'}" class="w-5 h-5 ${isError ? 'text-red-500' : 'text-green-400'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            if(window.lucide) window.lucide.createIcons();

            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            setTimeout(() => {
                toast.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        async function uploadToFreeImageHost(file) {
            const apiKey = currentSettings.freeImageHostApiKey;
            if (!apiKey) {
                showToast("Please save your FreeImage.Host API Key in Settings first.", true);
                return null;
            }

            const formData = new FormData();
            formData.append("source", file);

            try {
                const response = await fetch(`https://freeimage.host/api/1/upload?key=${apiKey}`, {
                    method: "POST",
                    body: formData,
                });

                const data = await response.json();

                if (data.status_code === 200 && data.image && data.image.url) {
                    return data.image.url;
                } else {
                    throw new Error(data.error ? data.error.message : (data.status_txt || "Upload failed"));
                }
            } catch (error) {
                console.error("Upload Error:", error);
                showToast("Image upload failed: " + error.message, true);
                return null;
            }
        }

        // --- Render Helpers ---
        function renderNavbar() {
            const activeClass = (view) => window.router.view === view ? 'text-rose-600 bg-rose-50' : 'text-gray-500 hover:text-rose-600 hover:bg-gray-50';
            
            return `
            <nav class="bg-white border-b border-rose-100 sticky top-0 z-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center h-auto sm:h-20 py-4 sm:py-0 gap-4 sm:gap-0">
                        <div class="flex items-center">
                            <a href="admin.html" class="flex items-center gap-3 btn-press">
                                <div class="bg-rose-500 text-white p-2 rounded-full shadow-md">
                                    <i data-lucide="feather" class="w-5 h-5"></i>
                                </div>
                                <span class="font-serif font-bold text-xl tracking-tight text-gray-900">Creator<span class="text-rose-500">Studio</span></span>
                            </a>
                        </div>
                        <div class="flex items-center space-x-1 sm:space-x-2 w-full sm:w-auto justify-center overflow-x-auto">
                             <button onclick="window.router.navigate('dashboard')" class="${activeClass('dashboard')} btn-press font-medium px-3 py-2 rounded-md transition flex items-center gap-2 text-xs sm:text-sm uppercase tracking-wide">
                                <i data-lucide="layout-grid" class="w-4 h-4"></i> <span class="hidden sm:inline">Stories</span>
                            </button>
                             <button onclick="window.router.navigate('pages')" class="${activeClass('pages')} btn-press font-medium px-3 py-2 rounded-md transition flex items-center gap-2 text-xs sm:text-sm uppercase tracking-wide">
                                <i data-lucide="file-text" class="w-4 h-4"></i> <span class="hidden sm:inline">Pages</span>
                            </button>
                             <button onclick="window.router.navigate('subscribers')" class="${activeClass('subscribers')} btn-press font-medium px-3 py-2 rounded-md transition flex items-center gap-2 text-xs sm:text-sm uppercase tracking-wide">
                                <i data-lucide="users" class="w-4 h-4"></i> <span class="hidden sm:inline">Subscribers</span>
                            </button>
                             <button onclick="window.router.navigate('settings')" class="${activeClass('settings')} btn-press font-medium px-3 py-2 rounded-md transition flex items-center gap-2 text-xs sm:text-sm uppercase tracking-wide">
                                <i data-lucide="settings" class="w-4 h-4"></i> <span class="hidden sm:inline">Settings</span>
                            </button>
                            <div class="h-6 w-px bg-gray-200 mx-2 hidden sm:block"></div>
                             <button onclick="window.actions.logout()" class="btn-press text-gray-400 hover:text-rose-600 p-2" title="Logout">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            `;
        }
        
        function renderLockScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-rose-50 px-4">
                    <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl w-full max-w-md text-center animate-enter border border-rose-100">
                        <div class="bg-rose-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                            <i data-lucide="lock" class="w-8 h-8 text-rose-500"></i>
                        </div>
                        <h1 class="font-serif text-3xl font-bold text-gray-900 mb-2">Creator Studio</h1>
                        <p class="text-gray-500 text-sm mb-8 font-medium">Enter passcode to access your dashboard</p>
                        
                        <form onsubmit="window.actions.unlock(event)" class="space-y-5">
                            <input type="password" id="unlock-pass" placeholder="••••••" class="w-full text-center text-3xl tracking-[0.5em] font-bold border border-gray-200 bg-gray-50 focus:bg-white focus:border-rose-500 focus:ring-4 focus:ring-rose-500/20 rounded-xl py-4 transition-all placeholder-gray-300 text-gray-800" autofocus required inputmode="numeric">
                            
                            <button type="submit" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-rose-500/30 transition transform active:scale-95 flex items-center justify-center gap-2">
                                <i data-lucide="unlock" class="w-4 h-4"></i> Unlock
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const postsArr = Object.entries(currentPosts || {}).map(([key, val]) => ({id: key, ...val})).reverse();
            
            let listHtml = '';
            if (postsArr.length === 0) {
                listHtml = `
                    <div class="p-10 sm:p-20 text-center text-gray-400 bg-white rounded-b-xl">
                        <i data-lucide="sparkles" class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-4 text-rose-200"></i>
                        <p class="mb-6 font-serif text-lg sm:text-xl text-gray-900">Your beauty journal is empty.</p>
                        <button onclick="window.router.navigate('new')" class="btn-press text-rose-600 font-medium hover:text-rose-700 hover:underline">Start writing your first article</button>
                    </div>
                `;
            } else {
                postsArr.forEach((post, index) => {
                    const dateStr = post.date ? new Date(post.date).toLocaleDateString() : '-';
                    const delay = index * 50; 
                    listHtml += `
                        <div class="p-4 sm:p-6 flex items-center justify-between hover:bg-rose-50/50 transition border-b border-gray-100 last:border-0 group animate-enter" style="animation-delay: ${delay}ms; opacity: 0; animation-fill-mode: forwards;">
                            <div class="flex-1 min-w-0 pr-4">
                                <h3 class="text-base sm:text-lg font-serif font-bold text-gray-900 truncate mb-1">${post.title || 'Untitled'}</h3>
                                <p class="text-[10px] sm:text-xs text-gray-500 flex flex-wrap items-center gap-2 sm:gap-3 uppercase tracking-wider">
                                    <span class="font-semibold text-gray-700 truncate max-w-[100px] sm:max-w-none">${post.author || 'Editor'}</span>
                                    <span class="w-1 h-1 bg-gray-300 rounded-full hidden sm:block"></span>
                                    <span>${dateStr}</span>
                                    ${(post.tags && post.tags[0]) ? `<span class="px-2 py-0.5 rounded-sm bg-rose-100 text-rose-700 text-[10px] font-bold hidden sm:inline-block">${post.tags[0]}</span>` : ''}
                                </p>
                            </div>
                            <div class="flex items-center gap-1 sm:gap-2">
                                <button onclick="window.router.navigate('edit', '${post.id}')" class="btn-press p-2 text-gray-400 hover:text-rose-600 bg-gray-50 sm:bg-transparent rounded-full sm:rounded-none transition" title="Edit">
                                    <i data-lucide="pen-line" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.actions.deletePost('${post.id}')" class="btn-press p-2 text-gray-400 hover:text-red-600 bg-gray-50 sm:bg-transparent rounded-full sm:rounded-none transition" title="Delete">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            return `
                ${renderNavbar()}
                <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-10 animate-enter">
                    <div class="flex justify-between items-center mb-6">
                         <h1 class="text-2xl font-serif font-bold text-gray-900">Stories</h1>
                         <button onclick="window.router.navigate('new')" class="btn-press bg-black hover:bg-gray-800 text-white px-5 py-2.5 rounded-full font-medium transition flex items-center gap-2 shadow-lg text-sm tracking-wide">
                            <i data-lucide="plus" class="w-4 h-4"></i> Create Story
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] border border-rose-100 overflow-hidden">
                        <div class="px-6 sm:px-8 py-4 sm:py-6 border-b border-rose-100 flex justify-between items-center bg-white">
                            <h2 class="text-lg sm:text-xl font-serif font-bold text-gray-900">Published</h2>
                            <div class="text-[10px] sm:text-xs font-bold text-rose-500 uppercase tracking-widest bg-rose-50 px-3 py-1 rounded-full border border-rose-100">${postsArr.length} ENTRIES</div>
                        </div>
                        <div class="divide-y divide-gray-100">
                            ${listHtml}
                        </div>
                    </div>
                </main>
            `;
        }

        function renderSubscribers() {
            const subsArr = Object.entries(currentSubscribers || {}).map(([key, val]) => ({id: key, ...val})).reverse();
            let listHtml = subsArr.length === 0 ? `<div class="p-10 text-center text-gray-400">No subscribers yet.</div>` : '';
            subsArr.forEach((sub, index) => {
                const dateStr = sub.date ? new Date(sub.date).toLocaleDateString() : '-';
                const delay = index * 50;
                if (!listHtml && subsArr.length > 0) listHtml = '';
                listHtml += `
                    <div class="p-4 flex items-center justify-between hover:bg-rose-50/50 transition border-b border-gray-100 last:border-0 animate-enter" style="animation-delay: ${delay}ms; opacity: 0; animation-fill-mode: forwards;">
                        <div>
                            <h3 class="text-sm font-bold text-gray-900">${sub.email}</h3>
                            <p class="text-xs text-gray-400">Subscribed on ${dateStr}</p>
                        </div>
                        <button onclick="window.actions.deleteSubscriber('${sub.id}')" class="btn-press text-gray-400 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
            });
            return `
                ${renderNavbar()}
                <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-10 animate-enter">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-serif font-bold text-gray-900">Newsletter Subscribers</h1>
                        <button onclick="window.actions.addSubscriber()" class="btn-press bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-full font-medium transition flex items-center gap-2 text-sm shadow-md"><i data-lucide="plus" class="w-4 h-4"></i> Add Subscriber</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-rose-100 overflow-hidden">
                        <div class="px-6 py-4 border-b border-rose-100 bg-gray-50 flex justify-between items-center">
                            <span class="text-xs font-bold uppercase tracking-widest text-gray-500">Email List</span>
                            <span class="bg-white text-rose-500 text-xs font-bold px-2 py-1 rounded border border-rose-100">${subsArr.length}</span>
                        </div>
                        <div class="divide-y divide-gray-100">${listHtml}</div>
                    </div>
                </main>
            `;
        }

        function renderPagesView() {
            const currentPageId = window.router.param || 'about';
            const content = currentPages[currentPageId] || '';
            const tabs = [{ id: 'about', label: 'About Us' }, { id: 'contact', label: 'Contact' }, { id: 'privacy', label: 'Privacy Policy' }];
            return `
                ${renderNavbar()}
                <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-10 animate-enter">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-serif font-bold text-gray-900">Manage Pages</h1>
                        <button onclick="window.actions.savePage(this, '${currentPageId}')" class="btn-press px-6 py-2 text-sm font-medium text-white bg-rose-500 rounded-full hover:bg-rose-600 shadow-md transition flex items-center justify-center min-w-[140px]">Save Changes</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-rose-100 overflow-hidden min-h-[500px] flex flex-col">
                        <div class="flex border-b border-rose-100 overflow-x-auto">
                            ${tabs.map(tab => `<button onclick="window.router.navigate('pages', '${tab.id}')" class="px-6 py-4 text-sm font-bold uppercase tracking-wider transition whitespace-nowrap btn-press ${currentPageId === tab.id ? 'text-rose-600 border-b-2 border-rose-500 bg-rose-50/50' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'}">${tab.label}</button>`).join('')}
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <p class="text-xs text-gray-400 mb-2 uppercase tracking-widest font-bold">Page Content (HTML supported)</p>
                            <textarea id="page-content" class="flex-1 w-full p-4 rounded-lg border border-gray-200 bg-gray-50 focus:bg-white focus:border-rose-300 focus:ring-1 focus:ring-rose-300 font-serif text-gray-800 leading-relaxed resize-none focus:outline-none transition-colors" placeholder="Write your content here...">${content}</textarea>
                        </div>
                    </div>
                </main>
            `;
        }

        function renderSettings() {
             return `
                ${renderNavbar()}
                <main class="max-w-3xl mx-auto px-4 sm:px-6 py-6 sm:py-10 animate-enter">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-serif font-bold text-gray-900">Settings</h1>
                        <button onclick="window.actions.saveSettings(this)" class="btn-press px-6 py-2 text-sm font-medium text-white bg-rose-500 rounded-full hover:bg-rose-600 shadow-md transition flex items-center justify-center min-w-[140px]">Save Changes</button>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-rose-100 space-y-8">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-1">Branding</h3>
                            <p class="text-sm text-gray-500 mb-4">Customize how your beauty hub looks to visitors.</p>
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Brand Name</label><input type="text" id="setting-brandName" value="${currentSettings.brandName || ''}" class="w-full rounded-lg border-gray-200 bg-rose-50/30 p-2 text-sm focus:border-rose-500 focus:ring-rose-500 transition"></div>
                                <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Logo URL (Optional)</label><div class="flex gap-2"><input type="text" id="setting-brandLogo" value="${currentSettings.brandLogo || ''}" placeholder="https://..." class="w-full rounded-lg border-gray-200 bg-rose-50/30 p-2 text-sm focus:border-rose-500 focus:ring-rose-500 transition"><label class="btn-press flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-600 rounded-lg cursor-pointer hover:bg-gray-200 transition text-sm font-medium whitespace-nowrap"><i data-lucide="upload" class="w-4 h-4 mr-2"></i> Upload<input type="file" class="hidden" onchange="window.actions.handleUpload(this, 'setting-brandLogo')"></label></div></div>
                            </div>
                        </div>
                         <div class="border-t border-gray-100 pt-8">
                            <h3 class="text-lg font-bold text-gray-900 mb-1">Security</h3>
                            <p class="text-sm text-gray-500 mb-4">Protect your creator studio.</p>
                            <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Admin Passcode</label><div class="relative"><input type="text" id="setting-passcode" value="${currentSettings.adminPasscode || ''}" placeholder="Enter 6-digit code" class="w-full rounded-lg border-gray-200 bg-rose-50/30 p-2 text-sm focus:border-rose-500 focus:ring-rose-500 transition font-mono tracking-widest"><i data-lucide="lock" class="absolute right-3 top-2.5 w-4 h-4 text-gray-400"></i></div></div>
                        </div>
                        <div class="border-t border-gray-100 pt-8">
                            <h3 class="text-lg font-bold text-gray-900 mb-1">Integrations</h3>
                            <p class="text-sm text-gray-500 mb-4">Configure external services.</p>
                             <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">FreeImage.Host API Key</label><input type="password" id="setting-api" value="${currentSettings.freeImageHostApiKey || ''}" placeholder="Enter your FreeImage.Host API key" class="w-full rounded-lg border-gray-200 bg-rose-50/30 p-2 text-sm focus:border-rose-500 focus:ring-rose-500 transition"><p class="text-xs text-gray-400 mt-2">Required for image uploads. Get one for free at <a href="https://freeimage.host/page/api" target="_blank" class="text-rose-500 underline">freeimage.host/page/api</a>.</p></div>
                        </div>
                    </div>
                </main>
            `;
        }

        function renderEditor(postId = null) {
            const existingPost = (postId && currentPosts && currentPosts[postId]) ? currentPosts[postId] : null;
            const post = existingPost || { title: '', excerpt: '', content: '', coverImage: '', tags: [], author: 'DreamyBeauty Team', adCode: '' };
            const isEditing = !!existingPost;
            
            // Initialize ad code state
            currentPostAdCode = post.adCode || "";

            return `
                <nav class="bg-white border-b border-rose-100 px-4 sm:px-6 py-4 sticky top-0 z-50">
                    <div class="max-w-5xl mx-auto flex justify-between items-center">
                        <div class="flex items-center gap-2 sm:gap-4">
                            <a href="#" onclick="window.router.navigate('dashboard'); return false;" class="text-gray-400 hover:text-gray-900 transition btn-press"><i data-lucide="arrow-left" class="w-5 h-5"></i></a>
                            <span class="font-serif font-bold text-lg sm:text-xl text-gray-900 truncate max-w-[120px] sm:max-w-none">${isEditing ? 'Edit Story' : 'New Story'}</span>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-3">
                            <button onclick="window.router.navigate('dashboard')" class="btn-press px-2 sm:px-4 py-2 text-[10px] sm:text-xs font-bold text-gray-500 hover:text-gray-900 uppercase tracking-wider">Discard</button>
                            <button onclick="window.actions.savePost(this, '${isEditing ? postId : ''}')" class="btn-press px-4 sm:px-6 py-2 text-xs sm:text-sm font-medium text-white bg-rose-500 rounded-full hover:bg-rose-600 shadow-md hover:shadow-lg transition transform whitespace-nowrap flex items-center justify-center min-w-[100px]">
                                ${isEditing ? 'Save' : 'Publish'}
                            </button>
                        </div>
                    </div>
                </nav>

                <main class="max-w-4xl mx-auto px-4 sm:px-6 py-6 sm:py-10 animate-enter relative">
                    <form id="postForm" class="space-y-6 sm:space-y-10" onsubmit="event.preventDefault();">
                        
                        <div class="space-y-4 sm:space-y-6">
                            <input type="text" id="input-title" value="${post.title || ''}" placeholder="The Secret to Glowing Skin..." class="w-full text-3xl sm:text-5xl font-serif font-bold border-none bg-transparent placeholder-gray-200 text-gray-900 focus:ring-0 focus:outline-none px-0 leading-tight transition-all" required>
                            <input type="text" id="input-excerpt" value="${post.excerpt || ''}" placeholder="Write a short, captivating summary..." class="w-full text-lg sm:text-xl text-gray-600 border-none bg-transparent placeholder-gray-300 focus:ring-0 focus:outline-none px-0 font-light transition-all">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Cover Image</label>
                                <div class="flex gap-2">
                                    <div class="relative flex-1">
                                        <i data-lucide="image" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                        <input type="url" id="input-image" value="${post.coverImage || ''}" placeholder="https://..." class="w-full pl-9 rounded-lg border-gray-200 bg-white p-2 text-sm focus:border-rose-500 focus:ring-rose-500 shadow-sm transition">
                                    </div>
                                    <label class="flex items-center justify-center px-4 py-2 bg-gray-900 text-white rounded-lg cursor-pointer hover:bg-gray-800 transition text-sm font-medium whitespace-nowrap shadow-md btn-press">
                                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Upload
                                        <input type="file" class="hidden" onchange="window.actions.handleUpload(this, 'input-image')">
                                    </label>
                                </div>
                            </div>
                             <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Author</label>
                                <input type="text" id="input-author" value="${post.author || 'DreamyBeauty Team'}" class="w-full rounded-lg border-gray-200 bg-white p-2 text-sm focus:border-rose-500 focus:ring-rose-500 shadow-sm transition">
                            </div>
                        </div>
                        
                        <div>
                             <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Topic Tags (Comma Separated)</label>
                             <input type="text" id="input-tags" value="${(post.tags || []).join(', ')}" placeholder="Skincare, Wellness, Makeup Trends" class="w-full rounded-lg border-gray-200 bg-white p-2 text-sm focus:border-rose-500 focus:ring-rose-500 shadow-sm transition">
                        </div>

                        <div class="relative">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Story Content</label>
                            
                            <!-- Editor Toolbar -->
                            <div class="flex items-center gap-1 mb-2 p-2 bg-gray-50 border border-rose-100 rounded-lg flex-wrap sticky top-[80px] z-40 shadow-sm">
                                <button onclick="window.actions.insertFormat('bold')" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition" title="Bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                                <button onclick="window.actions.insertFormat('italic')" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition" title="Italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                                <button onclick="window.actions.insertFormat('h2')" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition" title="Heading"><i data-lucide="heading-2" class="w-4 h-4"></i></button>
                                <button onclick="window.actions.insertFormat('quote')" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition" title="Quote"><i data-lucide="quote" class="w-4 h-4"></i></button>
                                <button onclick="window.actions.insertFormat('link')" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition" title="Link"><i data-lucide="link" class="w-4 h-4"></i></button>
                                <button onclick="window.actions.insertFormat('list')" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition" title="Bullet List"><i data-lucide="list" class="w-4 h-4"></i></button>
                                
                                <div class="w-px h-6 bg-gray-200 mx-1"></div>

                                <!-- Image Dropdown -->
                                <div class="relative inline-block">
                                    <button onclick="document.getElementById('editor-img-menu').classList.toggle('hidden')" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition flex items-center gap-2" title="Insert Image">
                                        <i data-lucide="image" class="w-4 h-4"></i> <span class="text-xs font-bold uppercase hidden sm:inline">Image</span> <i data-lucide="chevron-down" class="w-3 h-3"></i>
                                    </button>
                                    
                                    <div id="editor-img-menu" class="hidden absolute left-0 top-full mt-2 w-72 bg-white border border-rose-100 shadow-xl rounded-xl p-4 z-20 animate-enter">
                                        <div class="mb-4">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Upload Image</label>
                                            <label class="btn-press flex items-center justify-center w-full px-4 py-3 bg-rose-50 text-rose-600 rounded-lg cursor-pointer hover:bg-rose-100 transition text-sm font-bold border border-rose-100 border-dashed">
                                                <i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Choose File
                                                <input type="file" class="hidden" onchange="window.actions.editorUploadImage(this)">
                                            </label>
                                        </div>
                                        
                                        <div class="relative flex py-2 items-center">
                                            <div class="flex-grow border-t border-gray-100"></div>
                                            <span class="flex-shrink-0 mx-4 text-[10px] text-gray-400 font-bold uppercase">OR URL</span>
                                            <div class="flex-grow border-t border-gray-100"></div>
                                        </div>

                                        <div class="mt-2">
                                             <div class="flex gap-2">
                                                <input type="text" id="editor-img-url" placeholder="https://..." class="w-full rounded-md border-gray-200 bg-gray-50 p-2 text-xs focus:border-rose-500 focus:ring-rose-500">
                                                <button onclick="window.actions.editorInsertUrl()" class="bg-rose-500 text-white p-2 rounded-md hover:bg-rose-600 btn-press"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                             </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="w-px h-6 bg-gray-200 mx-1"></div>

                                <!-- Ad Button -->
                                <button onclick="window.actions.handleAdButtonClick()" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition flex items-center gap-2" title="Insert Ad">
                                    <i data-lucide="megaphone" class="w-4 h-4"></i> <span class="text-xs font-bold uppercase hidden sm:inline">AD</span>
                                </button>

                                <div class="w-px h-6 bg-gray-200 mx-1"></div>

                                <button onclick="window.actions.toggleCodeView()" class="btn-press p-2 hover:bg-white hover:text-rose-500 rounded text-gray-500 transition flex items-center gap-2" title="Switch to HTML View">
                                    <i data-lucide="code-2" class="w-4 h-4"></i> <span class="text-xs font-bold uppercase hidden sm:inline">HTML</span>
                                </button>
                            </div>
                            
                            <!-- Dual Editors -->
                            <div class="relative min-h-[500px] border border-rose-100 rounded-xl bg-white shadow-sm overflow-hidden group">
                                <!-- Visual Editor (WYSIWYG) -->
                                <div id="visual-editor" class="w-full h-full p-4 sm:p-8 font-serif text-base sm:text-lg leading-loose outline-none min-h-[500px] prose prose-rose max-w-none" contenteditable="true" placeholder="Start writing your beautiful story here...">${post.content || ''}</div>
                                
                                <!-- HTML Code Editor (Hidden by default) -->
                                <textarea id="html-editor" class="hidden w-full h-full p-4 font-mono text-sm bg-slate-900 text-green-400 outline-none resize-none min-h-[500px] leading-relaxed">${post.content || ''}</textarea>
                            </div>
                        </div>

                        <!-- Ad Code Modal (Hidden) -->
                        <div id="ad-code-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-enter">
                            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg mx-4 border border-rose-100">
                                <h3 class="text-lg font-serif font-bold text-gray-900 mb-2">Add your 320x50 banner code</h3>
                                <p class="text-xs text-gray-500 mb-4">Paste your full Adsterra/JS code here. This will be used for every [AD_SLOT] in this post.</p>
                                <textarea id="ad-code-input" class="w-full h-40 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs font-mono focus:border-rose-500 focus:ring-1 focus:ring-rose-500 outline-none resize-none" placeholder="<script>...<\/script>"></textarea>
                                <div class="flex justify-end gap-3 mt-4">
                                    <button onclick="window.actions.closeAdModal()" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-900 btn-press">Cancel</button>
                                    <button onclick="window.actions.saveAdCode()" class="px-4 py-2 text-sm bg-rose-500 text-white rounded-lg hover:bg-rose-600 shadow-md btn-press">Save & Insert</button>
                                </div>
                            </div>
                        </div>

                    </form>
                </main>
            `;
        }

        // --- App Controller ---
        const router = {
            view: 'dashboard',
            param: null,
            navigate: function(view, param = null) {
                this.view = view;
                this.param = param;
                render();
            }
        };

        const actions = {
            // ... [unlock, logout, handleUpload, insertFormat, editorInsertUrl, editorUploadImage, insertImageTag, toggleCodeView same as before] ...
            unlock: function(e) {
                e.preventDefault();
                const input = document.getElementById('unlock-pass');
                const val = input.value;
                const correct = currentSettings.adminPasscode || '798582';
                if(val === correct) { sessionStorage.setItem('admin_auth', 'true'); isAuthenticated = true; showToast('Welcome back.'); render(); } 
                else { input.classList.add('animate-shake'); setTimeout(() => input.classList.remove('animate-shake'), 500); showToast('Incorrect', true); }
            },
            logout: function() { sessionStorage.removeItem('admin_auth'); isAuthenticated = false; render(); },
            handleUpload: async function(input, targetId) { /* ... existing implementation ... */ 
                 if (input.files && input.files[0]) {
                    const originalHTML = input.parentElement.innerHTML;
                    input.parentElement.innerHTML = `Uploading...`;
                    const url = await uploadToFreeImageHost(input.files[0]);
                    input.parentElement.innerHTML = originalHTML;
                    if (url) { document.getElementById(targetId).value = url; showToast("Done!"); }
                }
            },
            insertFormat: function(command) {
                const visual = document.getElementById('visual-editor');
                const htmlMode = !document.getElementById('html-editor').classList.contains('hidden');
                if (htmlMode) { showToast("Switch to Visual View first", true); return; }
                visual.focus();
                if(command === 'h2') document.execCommand('formatBlock', false, 'h2');
                else if(command === 'quote') document.execCommand('formatBlock', false, 'blockquote');
                else if(command === 'link') { const url = prompt('URL:','https://'); if(url) document.execCommand('createLink', false, url); }
                else document.execCommand(command, false, null);
            },
            editorInsertUrl: function() { const url = document.getElementById('editor-img-url').value; if(url) this.insertImageTag(url); },
            editorUploadImage: async function(input) {
                if (input.files && input.files[0]) {
                    const url = await uploadToFreeImageHost(input.files[0]);
                    if (url) { this.insertImageTag(url); document.getElementById('editor-img-menu').classList.add('hidden'); }
                }
            },
            insertImageTag: function(url) {
                const htmlMode = !document.getElementById('html-editor').classList.contains('hidden');
                if (htmlMode) {
                    const ta = document.getElementById('html-editor');
                    ta.setRangeText(`<img src="${url}" class="w-full rounded-lg my-6 shadow-sm" />`, ta.selectionStart, ta.selectionEnd, 'end');
                } else {
                    document.getElementById('visual-editor').focus();
                    document.execCommand('insertHTML', false, `<img src="${url}" class="w-full rounded-lg my-6 shadow-sm"><br>`);
                }
            },
            toggleCodeView: function() {
                const visual = document.getElementById('visual-editor');
                const html = document.getElementById('html-editor');
                if (html.classList.contains('hidden')) { html.value = visual.innerHTML; visual.classList.add('hidden'); html.classList.remove('hidden'); } 
                else { visual.innerHTML = html.value; html.classList.add('hidden'); visual.classList.remove('hidden'); }
            },

            // --- New Ad Logic ---
            handleAdButtonClick: function() {
                if (currentPostAdCode && currentPostAdCode.trim() !== "") {
                    // Ad code exists, insert placeholder immediately
                    this.insertAdPlaceholder();
                    showToast("Ad slot inserted!");
                } else {
                    // No code, open modal
                    document.getElementById('ad-code-modal').classList.remove('hidden');
                }
            },
            
            closeAdModal: function() {
                document.getElementById('ad-code-modal').classList.add('hidden');
            },
            
            saveAdCode: function() {
                const code = document.getElementById('ad-code-input').value;
                if (!code || code.trim() === "") {
                    showToast("Please enter code or cancel", true);
                    return;
                }
                currentPostAdCode = code;
                this.closeAdModal();
                this.insertAdPlaceholder();
                showToast("Code saved & slot inserted!");
            },
            
            insertAdPlaceholder: function() {
                const placeholder = "[AD_SLOT]";
                const htmlMode = !document.getElementById('html-editor').classList.contains('hidden');
                
                if (htmlMode) {
                    const textarea = document.getElementById('html-editor');
                    textarea.setRangeText(placeholder, textarea.selectionStart, textarea.selectionEnd, 'end');
                    textarea.focus();
                } else {
                    const visual = document.getElementById('visual-editor');
                    visual.focus();
                    document.execCommand('insertText', false, placeholder);
                }
            },

            // ... [saveSettings, savePost, deletePost, addSubscriber, deleteSubscriber, savePage] ...
            saveSettings: function(btn) { /* ... existing ... */ 
                 // Simple wrapper to save space in this update
                 const brandName = document.getElementById('setting-brandName').value;
                 const brandLogo = document.getElementById('setting-brandLogo').value;
                 const adminPasscode = document.getElementById('setting-passcode').value;
                 const freeImageHostApiKey = document.getElementById('setting-api').value;
                 set(ref(db, 'settings'), { brandName, brandLogo, freeImageHostApiKey, adminPasscode }).then(()=>showToast("Saved"));
            },

            savePost: function(btn, id) {
                const title = document.getElementById('input-title').value;
                const excerpt = document.getElementById('input-excerpt').value;
                
                // Get Content
                const htmlMode = !document.getElementById('html-editor').classList.contains('hidden');
                const content = htmlMode ? document.getElementById('html-editor').value : document.getElementById('visual-editor').innerHTML;
                
                const coverImage = document.getElementById('input-image').value;
                const author = document.getElementById('input-author').value;
                const tagsVal = document.getElementById('input-tags').value;
                const tags = tagsVal ? tagsVal.split(',').map(t => t.trim()).filter(t => t) : [];

                if(!title) return showToast("Title is required", true);

                const originalText = btn.innerHTML;
                btn.innerHTML = `Saving...`;
                btn.disabled = true;

                const existingData = (id && currentPosts[id]) ? currentPosts[id] : {};

                const postData = {
                    ...existingData,
                    title, excerpt, content, coverImage, author, tags,
                    // Save the ad code with the post
                    adCode: currentPostAdCode,
                    date: existingData.date || new Date().toISOString()
                };

                const promise = id 
                    ? set(ref(db, 'posts/' + id), postData) 
                    : push(ref(db, 'posts'), postData);

                promise.then(() => {
                    showToast("Saved!");
                    router.navigate('dashboard');
                }).catch(err => {
                    showToast("Error", true);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            },
            deletePost: function(id) { if(confirm('Delete?')) remove(ref(db, 'posts/' + id)).then(()=>showToast("Deleted")); },
            addSubscriber: function() { 
                const email = prompt("Enter email address to subscribe:");
                if (email) {
                     if(email.includes('@') && email.includes('.')) {
                        push(ref(db, 'subscribers'), { email: email, date: new Date().toISOString() })
                        .then(() => showToast("Subscriber added."))
                        .catch(err => showToast("Error: " + err.message, true));
                     } else { showToast("Invalid email", true); }
                }
            },
            deleteSubscriber: function(id) { if(confirm('Remove?')) remove(ref(db, 'subscribers/' + id)).then(()=>showToast("Removed")); },
            savePage: function(btn, pageId) { const content = document.getElementById('page-content').value; set(ref(db, 'pages/' + pageId), content).then(()=>showToast("Saved")); }
        };

        window.router = router;
        window.actions = actions;

        // ... [Initial render logic same as before] ...
        function render() {
            const app = document.getElementById('app');
            if (!isSettingsLoaded) { app.innerHTML = `<div class="flex justify-center h-screen items-center">Loading...</div>`; return; }
            if (!isAuthenticated) { app.innerHTML = renderLockScreen(); if(window.lucide) window.lucide.createIcons(); return; }

            if (router.view === 'dashboard') app.innerHTML = renderDashboard();
            else if (router.view === 'new') app.innerHTML = renderEditor();
            else if (router.view === 'edit') app.innerHTML = renderEditor(router.param);
            else if (router.view === 'settings') app.innerHTML = renderSettings();
            else if (router.view === 'subscribers') app.innerHTML = renderSubscribers();
            else if (router.view === 'pages') app.innerHTML = renderPagesView();
            
            if(window.lucide) window.lucide.createIcons();
        }

        onValue(ref(db, 'posts'), (s) => { currentPosts = s.val() || {}; if (isAuthenticated && router.view === 'dashboard') render(); });
        onValue(ref(db, 'settings'), (s) => { 
            const d = s.val() || {}; 
            currentSettings = { brandName: d.brandName || 'DBH', brandLogo: d.brandLogo, freeImageHostApiKey: d.freeImageHostApiKey, adminPasscode: d.adminPasscode || '798582' }; 
            if(!isSettingsLoaded) { isSettingsLoaded = true; render(); }
        });
        onValue(ref(db, 'subscribers'), (s) => { currentSubscribers = s.val() || {}; if (isAuthenticated && router.view === 'subscribers') render(); });
        onValue(ref(db, 'pages'), (s) => { currentPages = s.val() || {}; if (isAuthenticated && router.view === 'pages') render(); });

        render();
    </script>
    <div id="app"></div>
</body>
</html>
